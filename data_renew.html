<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UPS Monitoring</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-2 sm:p-4">
  <div class="max-w-full mx-auto">
    <h1 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-center">UPS Monitoring</h1>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Region -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-1 sm:gap-2 mb-3 sm:mb-4">
      <button onclick="setRegionFilter('North1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">North1</button>
      <button onclick="setRegionFilter('North2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">North2</button>
      <button onclick="setRegionFilter('North3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">North3</button>
      <button onclick="setRegionFilter('Northeast1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Northeast1</button>
      <button onclick="setRegionFilter('Northeast2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Northeast2</button>
      <button onclick="setRegionFilter('Northeast3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Northeast3</button>
      <button onclick="setRegionFilter('Central1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Central1</button>
      <button onclick="setRegionFilter('Central2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Central2</button>
      <button onclick="setRegionFilter('Central3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Central3</button>
      <button onclick="setRegionFilter('Headquarters')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Headquarters</button>
      <button onclick="setRegionFilter('South1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">South1</button>
      <button onclick="setRegionFilter('South2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">South2</button>
      <button onclick="setRegionFilter('South3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">South3</button>
      <button onclick="setRegionFilter('SparePart')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">SparePart</button>
      <button onclick="clearFiltersAndReload()" class="region-btn bg-gray-400 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-gray-500 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <!-- Filters ‡πÅ‡∏•‡∏∞ Search -->
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
      <div class="sm:col-span-2">
        <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ UPS ID, Province, ‡∏´‡∏£‡∏∑‡∏≠ PEA" 
          class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white text-sm text-slate-600 placeholder-slate-400 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all duration-200" />
      </div>
      
      <select id="subregionFilter" 
        class="px-4 py-3 rounded-lg border border-slate-200 bg-white text-sm text-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all duration-200 cursor-pointer">
        <option value="">üìç ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
      </select>

      <select id="statusFilter" 
        class="px-4 py-3 rounded-lg border border-slate-200 bg-white text-sm text-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all duration-200 cursor-pointer">
        <option value="">üîµ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
        <option value="Normal">üü¢ Normal</option>
        <option value="Minor">üü° Minor</option>
        <option value="Major">üü† Major</option>
        <option value="Comm Error">‚ùå Comm Error</option>
      </select>

      <div id="dataCount" class="sm:col-span-4 text-slate-600 font-medium text-sm bg-slate-50 rounded-lg px-4 py-3">
        ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center z-50 hidden">
      <div class="bg-white/80 p-8 rounded-2xl shadow-lg text-center backdrop-blur-md">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-400 border-t-transparent mx-auto mb-4"></div>
        <p class="text-slate-600 text-lg font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
      </div>
    </div>

    <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå Status -->
    <div class="bg-gradient-to-r from-slate-50 to-blue-50 rounded-xl p-4 mb-6 border border-blue-100">
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
        <span class="flex items-center gap-2 text-slate-600">
          <span class="w-3 h-3 rounded-full bg-green-400 shadow-sm shadow-green-200"></span>
          <span>Normal - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</span>
        </span>
        <span class="flex items-ce‡∏únter gap-2 text-slate-600">
          <span class="w-3 h-3 rounded-full bg-yellow-400 shadow-sm shadow-yellow-200"></span>
          <span>Minor - ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>
        </span>
        <span class="flex items-center gap-2 text-slate-600">
          <span class="w-3 h-3 rounded-full bg-orange-400 shadow-sm shadow-orange-200"></span>
          <span>Major - ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á</span>
        </span>
        <span class="flex items-center gap-2 text-slate-600">
          <span class="w-3 h-3 rounded-full bg-red-400 shadow-sm shadow-red-200"></span>
          <span>Comm Error - ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
        </span>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="overflow-x-auto rounded-xl shadow-sm border border-slate-200">
      <table class="min-w-full bg-white text-sm">
        <thead class="bg-gradient-to-r from-slate-50 to-blue-50 text-slate-600 font-medium sticky top-0">
          <tr>
            <th class="py-3 px-4 text-left">Status</th>
            <th class="py-3 px-4 text-left">Region</th>
            <th class="py-3 px-4 text-left">Province</th>
            <th class="py-3 px-4 text-left">PEA</th>
            <th class="py-3 px-4 text-left">UPS ID</th>
            <th class="py-3 px-4 text-left">Last Signal</th>
            <th class="py-3 px-4 text-left">Event</th>
            <th class="py-3 px-4 text-left">Input (V)</th>
            <th class="py-3 px-4 text-left">Output (V)</th>
            <th class="py-3 px-4 text-left">Battery T</th>
            <th class="py-3 px-4 text-left">Battery V</th>
            <th class="py-3 px-4 text-left">UPS TEMP</th>
          </tr>
        </thead>
        <tbody id="ups-table" class="divide-y divide-slate-100">
          <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </tbody>
      </table>
    </div>
  </div>
  
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Smooth transitions */
    .transition-all {
      transition-property: all;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }
    
    /* Table row hover effect */
    #ups-table tr:hover {
      background-color: #f8fafc;
    }
    
    /* Active region button */
    .region-btn.active {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      color: white;
      border-color: #2563eb;
    }
  </style>

<script>
let fullData = [];
let currentRegion = '';

function getParam(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

function renderTable(data) {
  const table = document.getElementById("ups-table");
  table.innerHTML = "";

  if (data.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="12" class="text-center text-gray-400 py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
    table.appendChild(row);
    return;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  const sortedData = [...data].sort((a, b) => {
    const getSeverity = (status) => {
      switch(status) {
        case '000': return 4; // Comm Error - ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        case '010': return 3; // Major
        case '001': return 2; // Minor
        case '011': return 1; // Normal
        default: return 0;    // Unknown
      }
    };
    return getSeverity(b.status_id) - getSeverity(a.status_id);
  });

  sortedData.forEach(item => {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
    let statusInfo;
    
    switch(item.status_id) {
      case '011':
        statusInfo = {
          meaning: 'Normal',
          symbol: 'üü¢',
          class: 'text-green-600 font-bold text-lg'
        };
        break;
      case '001':
        statusInfo = {
          meaning: 'Minor',
          symbol: 'üü°',
          class: 'text-yellow-600 font-bold text-lg'
        };
        break;
      case '010':
        statusInfo = {
          meaning: 'Major',
          symbol: 'üü†',
          class: 'text-orange-600 font-bold text-lg'
        };
        break;
      case '000':
        statusInfo = {
          meaning: 'Comm Error',
          symbol: '‚ùå',
          class: 'text-red-600 font-bold text-lg'
        };
        break;
      default:
        statusInfo = {
          meaning: 'Unknown',
          symbol: '‚ùì',
          class: 'text-gray-600 font-bold text-lg'
        };
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tooltip
    const eventDetail = item.event_description ? `\n${item.event_description}` : '';
    const tooltipText = `${statusInfo.meaning} - ${item.event_name || 'Unknown'}${eventDetail}`;
    
    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50";
    row.innerHTML = `
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-center ${statusInfo.class}" title="${tooltipText}">${statusInfo.symbol}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.region_name}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.subregion_name}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.pea_code_name}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-blue-600 underline text-xs sm:text-sm">
        <a href="ups_detail.html?ups_id=${encodeURIComponent(item.ups_id)}" target="content-frame" class="hover:text-blue-800">
          ${item.ups_id}
        </a>
      </td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm whitespace-nowrap">${item.last_signal_updated ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm group relative">
        <div class="hover:cursor-help" title="${tooltipText}">
          ${item.event_name || 'Unknown'}
          ${item.event_description ? `
          <div class="opacity-0 bg-black text-white text-xs rounded-lg py-2 px-3 absolute z-10 group-hover:opacity-100 bottom-full left-0 mb-2 pointer-events-none whitespace-normal max-w-xs">
            ${item.event_description}
          </div>` : ''}
        </div>
      </td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.input_voltage ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.output_voltage ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.batt_temp ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.battery_voltage ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.ups_temp ?? '-'}</td>
    `;
    table.appendChild(row);
  });
}

function applyFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const subregion = document.getElementById("subregionFilter").value;
  const statusFilter = document.getElementById("statusFilter").value;

  const filtered = fullData.filter(item => {
    const matchRegion = currentRegion === '' || item.region_name === currentRegion;
    const matchSubregion = subregion === '' || item.subregion_name === subregion;
    
    let itemStatusMeaning;
    switch(item.status_id) {
      case '011': itemStatusMeaning = 'Normal'; break;
      case '001': itemStatusMeaning = 'Minor'; break;
      case '010': itemStatusMeaning = 'Major'; break;
      case '000': itemStatusMeaning = 'Comm Error'; break;
      default: itemStatusMeaning = 'Unknown';
    }
    const matchStatus = statusFilter === '' || itemStatusMeaning === statusFilter;

    const matchSearch =
      item.ups_id.toLowerCase().includes(search) ||
      item.subregion_name.toLowerCase().includes(search) ||
      item.pea_code_name.toLowerCase().includes(search) ||
      item.region_name.toLowerCase().includes(search) ||
      (item.event_name && item.event_name.toLowerCase().includes(search));

    return matchRegion && matchSubregion && matchStatus && matchSearch;
  });

  renderTable(filtered);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
  const countDisplay = document.getElementById("dataCount");
  if (countDisplay) {
    countDisplay.textContent = `‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }
}

function setRegionFilter(region) {
  currentRegion = region;

  // ‡∏•‡πâ‡∏≤‡∏á pea_code_id ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å URL
  const url = new URL(window.location);
  url.searchParams.delete('pea_code_id');
  window.history.replaceState({}, '', url);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° region ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  document.querySelectorAll('.region-btn').forEach(btn => {
    if (btn.textContent === region || (region === '' && btn.textContent === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) {
      btn.classList.add('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    } else {
      btn.classList.remove('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    }
  });

  updateSubregionDropdown();
  applyFilters();
}

function updateSubregionDropdown() {
  const subregionSelect = document.getElementById("subregionFilter");
  subregionSelect.innerHTML = '<option value="">-- Province --</option>';

  let subregionsSet = new Set();
  fullData.forEach(item => {
    if (currentRegion === '' || item.region_name === currentRegion) {
      if (item.subregion_name) subregionsSet.add(item.subregion_name);
    }
  });

  [...subregionsSet].sort().forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    subregionSelect.appendChild(opt);
  });

  subregionSelect.value = '';
}

function clearFiltersAndReload() {
  // ‡∏•‡∏ö pea_code_id ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å URL
  const url = new URL(window.location);
  url.searchParams.delete('pea_code_id');
  window.history.replaceState({}, '', url);

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
  currentRegion = '';
  document.getElementById("subregionFilter").value = '';
  document.getElementById("statusFilter").value = '';
  document.getElementById("searchInput").value = '';

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå
  document.querySelectorAll('.region-btn').forEach(btn => {
    if (btn.textContent === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
      btn.classList.add('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    } else {
      btn.classList.remove('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    }
  });

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
  loadData();
}

function showLoading() {
  document.getElementById("loadingScreen").classList.remove("hidden");
}

function hideLoading() {
  document.getElementById("loadingScreen").classList.add("hidden");
}

function loadData() {
  showLoading();
  const peaCodeId = getParam('pea_code_id');
  let url = 'data.php';
  if (peaCodeId) {
    url += '?pea_code_id=' + encodeURIComponent(peaCodeId);
  }

  fetch(url)
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      return res.json();
    })
    .then(data => {
      console.log('Data received:', data);
      if (Array.isArray(data)) {
        fullData = data;
        console.log(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

        if (data.length > 0 && peaCodeId) {
          currentRegion = data[0].region_name || '';
          document.getElementById('subregionFilter').value = data[0].subregion_name || '';
          
          // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏° region
          document.querySelectorAll('.region-btn').forEach(btn => {
            if (btn.textContent === currentRegion) {
              btn.classList.add('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
            } else {
              btn.classList.remove('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
            }
          });
        } else {
          currentRegion = '';
        }

        updateSubregionDropdown();
        applyFilters();
      } else {
        throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    })
    .catch(error => {
      console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
      document.getElementById('ups-table').innerHTML = `
        <tr>
          <td colspan="12" class="text-center py-6">
            <div class="text-red-500 mb-2">${error.message}</div>
            <button onclick="loadData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
              ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </button>
          </td>
        </tr>`;
    })
    .finally(() => {
      hideLoading();
    });
}

// Event listeners
document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("subregionFilter").addEventListener("change", applyFilters);
document.getElementById("statusFilter").addEventListener("change", applyFilters);

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
loadData();
</script>
</body>
</html>
