<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>UPS Monitoring</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-2 sm:p-4">
  <div class="max-w-full mx-auto">
    <h1 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-center">UPS Monitoring</h1>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Region -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-1 sm:gap-2 mb-3 sm:mb-4">
      <button onclick="setRegionFilter('North1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">North1</button>
      <button onclick="setRegionFilter('North2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">North2</button>
      <button onclick="setRegionFilter('North3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">North3</button>
      <button onclick="setRegionFilter('Northeast1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Northeast1</button>
      <button onclick="setRegionFilter('Northeast2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Northeast2</button>
      <button onclick="setRegionFilter('Northeast3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Northeast3</button>
      <button onclick="setRegionFilter('Central1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Central1</button>
      <button onclick="setRegionFilter('Central2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Central2</button>
      <button onclick="setRegionFilter('Central3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Central3</button>
      <button onclick="setRegionFilter('Headquarters')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">Headquarters</button>
      <button onclick="setRegionFilter('South1')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">South1</button>
      <button onclick="setRegionFilter('South2')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">South2</button>
      <button onclick="setRegionFilter('South3')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">South3</button>
      <button onclick="setRegionFilter('SparePart')" class="region-btn bg-blue-500 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-blue-600 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">SparePart</button>
      <button onclick="clearFiltersAndReload('')" class="region-btn bg-gray-400 text-white rounded px-2 sm:px-3 py-1 sm:py-2 hover:bg-gray-500 text-xs sm:text-sm min-h-[32px] sm:min-h-[36px]">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <!-- Filters ‡πÅ‡∏•‡∏∞ Search -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
      <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ UPS ID, Province, ‡∏´‡∏£‡∏∑‡∏≠ PEA" class="border rounded px-3 py-2 w-full sm:w-auto sm:flex-1 text-sm sm:text-base min-h-[40px]" />

      <select id="subregionFilter" class="border rounded px-3 py-2 w-full sm:w-auto text-sm sm:text-base min-h-[40px]">
        <option value="">-- Province --</option>
      </select>

      <select id="statusFilter" class="border rounded px-3 py-2 w-full sm:w-auto text-sm sm:text-base min-h-[40px]">
        <option value="">-- Status --</option>
        <option value="Normal">Normal</option>
        <option value="Minor">Minor</option>
        <option value="Major">Major</option>
        <option value="Comm Error">Comm Error</option>
      </select>

      <div id="dataCount" class="text-gray-600 font-medium text-sm sm:text-base whitespace-nowrap">
      ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </div>

    </div>

      <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-solid mx-auto mb-4"></div>
      <p class="text-gray-700 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  </div>

    <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå Status -->
    <div class="bg-gray-50 rounded p-2 mb-3 border-l-4 border-blue-400">
      <div class="flex flex-wrap gap-4 text-xs text-gray-600">
        <span class="flex items-center gap-1"><span class="text-green-600 font-bold text-lg">‚óè</span> Normal - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</span>
        <span class="flex items-center gap-1"><span class="text-yellow-600 font-bold text-lg">‚ñ≤</span> Minor - ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>
        <span class="flex items-center gap-1"><span class="text-orange-600 font-bold text-lg">‚ñ†</span> Major - ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á</span>
        <span class="flex items-center gap-1"><span class="text-red-600 font-bold text-lg">‚ùå</span> Comm Error - ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="overflow-x-auto rounded-lg shadow">
      <table class="min-w-full bg-white border text-xs sm:text-sm leading-relaxed">
        <thead class="bg-gray-200 text-xs sm:text-sm font-semibold sticky top-0">
          <tr class="text-left">
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Status</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Region</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Province</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">PEA</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">UPS ID</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Last Signal</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Event</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Input (V)</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Output (V)</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Battery T</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">Battery V</th>
            <th class="py-2 px-1 sm:px-2 border whitespace-nowrap">UPS</th>
            
          </tr>
        </thead>
        <tbody id="ups-table">
          <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </tbody>
      </table>
    </div>
  </div>

<script>
  let fullData = [];
  let currentRegion = '';

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ parameter ‡∏à‡∏≤‡∏Å URL
  function getParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  function renderTable(data) {
  const table = document.getElementById("ups-table");
  table.innerHTML = "";

  if (data.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="12" class="text-center text-gray-400 py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
    table.appendChild(row);
    return;
  }

   data.forEach(item => {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏° event / status
    const statusTextMap = {
      '‚úÖ': 'Normal',
      '‚ö†Ô∏è': 'Minor', 
      'üî¥': 'Major',
      '‚ùå': 'Comm Error',
      '‚ùì': 'Unknown'
    };

    const statusMeaning = statusTextMap[item.status] || 'Unknown';
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤
    const statusSymbol = statusMeaning === 'Normal' ? '‚óè' :
                         statusMeaning === 'Minor' ? '‚ñ≤' :
                         statusMeaning === 'Major' ? '‚ñ†' :
                         statusMeaning === 'Comm Error' ? '‚ùå' : '?';

    const statusClass = statusMeaning === 'Normal' ? 'text-green-600 font-bold text-lg' :
                        statusMeaning === 'Minor' ? 'text-yellow-600 font-bold text-lg' :
                        statusMeaning === 'Major' ? 'text-orange-600 font-bold text-lg' :
                        statusMeaning === 'Comm Error' ? 'text-red-600 font-bold text-lg' :
                        'text-gray-600 font-bold text-lg';

    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50";
    row.innerHTML = `
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-center ${statusMeaning === 'Comm Error' ? 'font-bold text-lg' : statusClass}" title="${statusMeaning}" ${statusMeaning === 'Comm Error' ? 'style="color: #ff0000 !important;"' : ''}>${statusSymbol}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.region_name}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.subregion_name}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.pea_code_name}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-blue-600 underline text-xs sm:text-sm">
        <a href="ups_detail.html?ups_id=${encodeURIComponent(item.ups_id)}" target="content-frame" class="hover:text-blue-800">
          ${item.ups_id}
        </a>
      </td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm whitespace-nowrap">${item.last_signal_updated ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.event ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.input_voltage ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.output_voltage ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.batt_temp ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.battery_voltage ?? '-'}</td>
      <td class="border px-1 sm:px-2 py-1 sm:py-2 text-xs sm:text-sm">${item.ups_temp ?? '-'}</td>
    `;
    table.appendChild(row);
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å filter ‡πÅ‡∏•‡∏∞ search
function applyFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const subregion = document.getElementById("subregionFilter").value;
  const statusFilter = document.getElementById("statusFilter").value;

  const filtered = fullData.filter(item => {
    const statusTextMap = {
      '‚úÖ': 'Normal',
      '‚ö†Ô∏è': 'Minor',
      'üî¥': 'Major', 
      '‚ùå': 'Comm Error',
      '‚ùì': 'Unknown'
    };
    const statusMeaning = statusTextMap[item.status] || 'Unknown';

    const matchRegion = currentRegion === '' || item.region_name === currentRegion;
    const matchSubregion = subregion === '' || item.subregion_name === subregion;
    const matchStatus = statusFilter === '' || statusMeaning === statusFilter;

    const matchSearch =
      item.ups_id.toLowerCase().includes(search) ||
      item.subregion_name.toLowerCase().includes(search) ||
      item.pea_code_name.toLowerCase().includes(search) ||
      item.region_name.toLowerCase().includes(search);

    return matchRegion && matchSubregion && matchStatus && matchSearch;
  });

  renderTable(filtered);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
  const countDisplay = document.getElementById("dataCount");
  if (countDisplay) {
    countDisplay.textContent = `‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }
}


  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° Region
  function setRegionFilter(region) {
  currentRegion = region;

  // ‡∏•‡πâ‡∏≤‡∏á pea_code_id ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å URL (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å sidebar)
  const url = new URL(window.location);
  url.searchParams.delete('pea_code_id');
  window.history.replaceState({}, '', url);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å data.php (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á pea_code_id)
  fetch('data.php')
    .then(response => response.json())
    .then(data => {
      fullData = data;
      applyFilters(); // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ region
    })
    .catch(error => {
      console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
    });

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° region ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  document.querySelectorAll('.region-btn').forEach(btn => {
    if (btn.textContent === region || (region === '' && btn.textContent === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) {
      btn.classList.add('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    } else {
      btn.classList.remove('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    }
  });
  updateSubregionDropdown();
}


  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏ï‡∏≤‡∏° region ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  function updateSubregionDropdown() {
    const subregionSelect = document.getElementById("subregionFilter");
    subregionSelect.innerHTML = '<option value="">-- Province --</option>';

    let subregionsSet = new Set();
    fullData.forEach(item => {
      if (currentRegion === '' || item.region_name === currentRegion) {
        if (item.subregion_name) subregionsSet.add(item.subregion_name);
      }
    });

    [...subregionsSet].sort().forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      subregionSelect.appendChild(opt);
    });

    subregionSelect.value = '';
  }

  function clearFiltersAndReload() {
  // ‡∏•‡∏ö pea_code_id ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å URL
  const url = new URL(window.location);
  url.searchParams.delete('pea_code_id');
  window.history.replaceState({}, '', url);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  currentRegion = '';
  document.getElementById("subregionFilter").value = '';
  document.getElementById("statusFilter").value = '';
  document.getElementById("searchInput").value = '';

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå
  document.querySelectorAll('.region-btn').forEach(btn => {
    if (btn.textContent === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
      btn.classList.add('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    } else {
      btn.classList.remove('bg-blue-700', 'ring', 'ring-blue-300', 'font-bold');
    }
  });

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  loadData();
}

function showLoading() {
  console.log("üîµ Show Loading");
  document.getElementById("loadingScreen").classList.remove("hidden");
}

function hideLoading() {
  console.log("‚ö™ Hide Loading");
  document.getElementById("loadingScreen").classList.add("hidden");
}


function fetchData() {
  showLoading(); // üëà ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î

  fetch("data.php")
    .then(response => response.json())
    .then(data => {
      fullData = data;
      applyFilters();
    })
    .catch(error => {
      console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
    })
    .finally(() => {
      hideLoading(); // üëà ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    });
}

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å PHP ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö pea_code_id ‡πÉ‡∏ô URL
  function loadData() {
    showLoading();
    const peaCodeId = getParam('pea_code_id');
    let url = 'data.php';
    if (peaCodeId) {
      url += '?pea_code_id=' + encodeURIComponent(peaCodeId);
    }

    fetch(url)
      .then(res => res.json())
      .then(data => {
        fullData = data;

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ pea_code_id ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á currentRegion ‡πÅ‡∏•‡∏∞ subregion ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡πÅ‡∏£‡∏Å
        if (fullData.length > 0 && peaCodeId) {
          currentRegion = fullData[0].region_name || '';
          updateSubregionDropdown();

          document.getElementById('subregionFilter').value = fullData[0].subregion_name || '';
          
          // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏° region ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö currentRegion
          document.querySelectorAll('.region-btn').forEach(btn => {
            if (btn.textContent === currentRegion) {
              btn.classList.add('bg-blue-700');
            } else {
              btn.classList.remove('bg-blue-700');
            }
          });
        } else {
          currentRegion = '';
          updateSubregionDropdown();
        }

        applyFilters();
      })
      .catch(err => console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', err))
      .finally(() => {
      hideLoading(); // üëà ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
      });
  }

  // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("subregionFilter").addEventListener("change", applyFilters);
  document.getElementById("statusFilter").addEventListener("change", applyFilters);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
  loadData();

</script>
</body>
</html>
