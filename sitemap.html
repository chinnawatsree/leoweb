<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPS Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    
    /* Responsive map height */
    #map { 
      height: 50vh; 
      width: 100%; 
      min-height: 300px;
    }
    
    .status.Normal { color: #22c55e; font-weight: bold; }
    .status.Minor { color: #f59e42; font-weight: bold; }
    .status.Major { color: #ef4444; font-weight: bold; }
    .status.Comm\ Error { color: #ff0000; font-weight: bold; }
    .popup-btn { color: #2563eb; text-decoration: underline; margin-top: 4px; display: inline-block; }
    
    /* Responsive province section */
    .province-section { 
      padding: 15px 10px; 
      background: #f1f5f9; 
      display: flex; 
      flex-direction: column; 
      align-items: center;
      max-height: 50vh;
      overflow-y: auto;
    }
    
    /* Responsive search bar */
    .search-bar { 
      width: 100%; 
      max-width: 280px; 
      padding: 8px 12px; 
      margin-bottom: 15px; 
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      font-size: 16px;
      box-sizing: border-box;
    }
    
    /* Responsive province grid */
    .province-grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px; 
      width: 100%;
      max-width: 100%;
      justify-items: center;
    }
    
    /* Responsive province cards */
    .province-card { 
      background: #fff; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      padding: 8px 12px; 
      cursor: pointer; 
      transition: all 0.2s; 
      width: 100%;
      max-width: 140px;
      min-width: 90px;
      text-align: center;
      box-sizing: border-box;
    }
    
    .province-card:hover, .province-card:focus { 
      border-color: #6366f1; 
      box-shadow: 0 3px 8px rgba(99, 102, 241, 0.15); 
      transform: translateY(-1px); 
      outline: none; 
    }
    
    .province-card:focus { 
      outline: 2px solid #6366f1; 
      outline-offset: 2px; 
    }
    
    .province-card.active { 
      border-color: #6366f1; 
      background: #eef2ff; 
    }
    
    .province-name { 
      font-weight: 600; 
      color: #374151; 
      margin-bottom: 4px; 
      font-size: 14px;
      line-height: 1.2;
    }
    
    .province-count { 
      color: #6366f1; 
      font-size: 12px; 
      font-weight: 500; 
    }
    
    .hidden { display: none !important; }
    
    .show-all-btn { 
      background: #10b981; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 6px; 
      font-size: 14px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.2s; 
      margin-bottom: 15px;
      touch-action: manipulation;
    }
    
    .show-all-btn:hover, .show-all-btn:focus { 
      background: #059669; 
      transform: translateY(-1px); 
      outline: 2px solid #10b981; 
      outline-offset: 2px; 
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Loading screen responsive */
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    
    /* Media queries for different screen sizes */
    @media (min-width: 640px) {
      #map { height: 60vh; }
      .province-section { padding: 20px 15px; }
      .search-bar { max-width: 320px; }
      .province-grid { gap: 12px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .province-card { padding: 12px 16px; max-width: 160px; min-width: 120px; }
      .province-name { font-size: 16px; }
      .province-count { font-size: 14px; }
    }
    
    @media (min-width: 768px) {
      #map { height: 70vh; }
      .province-section { max-height: 30vh; }
      .search-bar { max-width: 350px; }
    }
    
    @media (min-width: 1024px) {
      #map { height: 75vh; }
      .province-section { max-height: 25vh; }
      .search-bar { max-width: 400px; }
      .province-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    }
    
    @media (min-width: 1280px) {
      #map { height: 80vh; }
      .province-section { max-height: 20vh; }
    }
    
    /* Mobile landscape orientation */
    @media (max-height: 500px) and (orientation: landscape) {
      #map { height: 40vh; min-height: 200px; }
      .province-section { max-height: 60vh; padding: 10px; }
      .province-card { padding: 6px 10px; }
      .province-name { font-size: 12px; }
      .province-count { font-size: 11px; }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .province-card { min-height: 44px; }
      .show-all-btn { min-height: 44px; }
    }
    
    /* Custom tooltip responsive */
    .leaflet-popup-content-wrapper {
      border-radius: 12px !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
    }
    
    .leaflet-popup-content {
      margin: 8px !important;
      font-size: 14px !important;
      line-height: 1.4 !important;
    }
    
    @media (max-width: 640px) {
      .leaflet-popup-content {
        font-size: 12px !important;
        margin: 6px !important;
      }
    }
    
    /* Ensure map controls are touch-friendly */
    .leaflet-control-zoom a {
      width: 30px !important;
      height: 30px !important;
      line-height: 30px !important;
      font-size: 18px !important;
    }
    
    @media (max-width: 640px) {
      .leaflet-control-zoom a {
        width: 36px !important;
        height: 36px !important;
        line-height: 36px !important;
        font-size: 20px !important;
      }
    }
  </style>
</head>
<body style="margin:0; padding:0;">
  <div id="map" role="application" aria-label="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á UPS"></div>
  
  <div class="province-section" role="region" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
    <label for="searchInput" class="sr-only">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
    <input type="text" id="searchInput" class="search-bar" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..." aria-describedby="search-help">
    <div id="search-help" class="sr-only">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</div>
    <button id="showAllBtn" class="show-all-btn hidden" onclick="showAllProvinces()" aria-label="‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üåç ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-solid mx-auto mb-4"></div>
      <p class="text-gray-700 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  </div>
    <div id="provinceGrid" class="province-grid" role="grid" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"></div>
  </div>
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([13.736717, 100.523186], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    let openTooltip = null;
    let tooltipTimeout;
      
    function getMarkerColor(devices) {
      for (const device of devices) {
        if (device.status === 'Major' || device.status === 'Comm Error') {
          return 'red';
        }
      }
      return 'blue';
    }

    function createTooltipCard(location) {
      const card = document.createElement('div');
      card.style.minWidth = '250px';
      card.style.maxWidth = '350px';
      card.style.background = '#fff';
      card.style.borderRadius = '14px';
      card.style.boxShadow = '0 2px 8px #e0e7ff';
      card.style.padding = '16px 14px 12px 14px';
      card.style.margin = '0';
      card.style.fontFamily = 'inherit';
      card.style.maxHeight = '400px';
      card.style.overflowY = 'auto';

      if (location.devices.length === 1) {
        const device = location.devices[0];
        
        const site = document.createElement('div');
        site.textContent = device.pea_code_name ?? '-';
        site.style.fontSize = '1.15rem';
        site.style.fontWeight = 'bold';
        site.style.color = '#3730a3';
        site.style.marginBottom = '8px';
        card.appendChild(site);

        const statusRow = document.createElement('div');
        statusRow.style.display = 'flex';
        statusRow.style.alignItems = 'center';
        statusRow.style.marginBottom = '8px';

        const statusLabel = document.createElement('span');
        statusLabel.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ';
        statusLabel.style.fontSize = '0.95rem';
        statusLabel.style.color = '#64748b';
        statusRow.appendChild(statusLabel);

        const statusSpan = document.createElement('span');
        statusSpan.textContent = device.status ?? '-';
        statusSpan.className = `status ${device.statusClass}`;
        statusSpan.style.fontSize = '1.05rem';
        statusSpan.style.padding = '2px 14px';
        statusSpan.style.borderRadius = '16px';
        statusSpan.style.marginLeft = '6px';
        statusSpan.style.fontWeight = 'bold';
        statusSpan.style.background = '#f1f5f9';
        statusRow.appendChild(statusSpan);
        card.appendChild(statusRow);

        const lastUpdate = document.createElement('div');
        lastUpdate.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${device.last_signal_updated ?? '-'}`;
        lastUpdate.style.fontSize = '0.95rem';
        lastUpdate.style.color = '#334155';
        lastUpdate.style.marginBottom = '12px';
        card.appendChild(lastUpdate);

        const link = document.createElement('a');
        link.href = `ups_detail.html?ups_id=${device.ups_id}`;
        link.textContent = '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        link.className = 'popup-btn';
        link.target = 'content-frame';
        link.style.display = 'block';
        link.style.width = '100%';
        link.style.textAlign = 'center';
        link.style.background = '#6366f1';
        link.style.color = '#fff';
        link.style.fontWeight = 'bold';
        link.style.fontSize = '1rem';
        link.style.padding = '8px 0';
        link.style.borderRadius = '8px';
        link.style.marginTop = '4px';
        link.style.textDecoration = 'none';
        link.style.transition = 'background 0.2s';
        link.onmouseover = () => link.style.background = '#4338ca';
        link.onmouseout = () => link.style.background = '#6366f1';
        card.appendChild(link);
      } else {
        const title = document.createElement('div');
        title.textContent = `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ ${location.devices.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á`;
        title.style.fontSize = '1.15rem';
        title.style.fontWeight = 'bold';
        title.style.color = '#3730a3';
        title.style.marginBottom = '12px';
        title.style.textAlign = 'center';
        card.appendChild(title);

        location.devices.forEach((device, index) => {
          const deviceDiv = document.createElement('div');
          deviceDiv.style.border = '1px solid #e2e8f0';
          deviceDiv.style.borderRadius = '8px';
          deviceDiv.style.padding = '8px';
          deviceDiv.style.marginBottom = '8px';
          deviceDiv.style.background = '#f8fafc';

          const deviceName = document.createElement('div');
          deviceName.textContent = `${device.ups_id} - ${device.pea_code_name}`;
          deviceName.style.fontSize = '0.95rem';
          deviceName.style.fontWeight = 'bold';
          deviceName.style.color = '#1e293b';
          deviceName.style.marginBottom = '4px';
          deviceDiv.appendChild(deviceName);

          const deviceStatus = document.createElement('span');
          deviceStatus.textContent = device.status ?? '-';
          deviceStatus.className = `status ${device.statusClass}`;
          deviceStatus.style.fontSize = '0.85rem';
          deviceStatus.style.padding = '2px 8px';
          deviceStatus.style.borderRadius = '12px';
          deviceStatus.style.background = '#f1f5f9';
          deviceDiv.appendChild(deviceStatus);

          const deviceLink = document.createElement('a');
          deviceLink.href = `ups_detail.html?ups_id=${device.ups_id}`;
          deviceLink.textContent = '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          deviceLink.target = 'content-frame';
          deviceLink.style.display = 'inline-block';
          deviceLink.style.marginTop = '4px';
          deviceLink.style.padding = '4px 8px';
          deviceLink.style.background = '#6366f1';
          deviceLink.style.color = '#fff';
          deviceLink.style.fontSize = '0.8rem';
          deviceLink.style.borderRadius = '4px';
          deviceLink.style.textDecoration = 'none';
          deviceLink.style.transition = 'background 0.2s';
          deviceLink.onmouseover = () => deviceLink.style.background = '#4338ca';
          deviceLink.onmouseout = () => deviceLink.style.background = '#6366f1';
          deviceDiv.appendChild(deviceLink);

          card.appendChild(deviceDiv);
        });
      }
      return card;
    }

    function addMarkerEvents(marker, card) {
      marker.on('mouseover', function (e) {
        clearTimeout(tooltipTimeout);
        if (openTooltip) {
          map.closePopup(openTooltip);
        }
        
        const popup = L.popup({
          closeButton: false,
          autoClose: false,
          closeOnClick: false,
          className: 'custom-tooltip'
        })
        .setLatLng(e.latlng)
        .setContent(card)
        .openOn(map);
        
        openTooltip = popup;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup
        card.addEventListener('mouseenter', () => {
          clearTimeout(tooltipTimeout);
        });
        
        card.addEventListener('mouseleave', () => {
          tooltipTimeout = setTimeout(() => {
            if (openTooltip) {
              map.closePopup(openTooltip);
              openTooltip = null;
            }
          }, 1000);
        });
      });

      marker.on('mouseout', function (e) {
        tooltipTimeout = setTimeout(() => {
          if (openTooltip) {
            map.closePopup(openTooltip);
            openTooltip = null;
          }
        }, 1000);
      });
    }

    let allTools = [];
    let provinceCache = null;
    let searchTimeout = null;
    let currentFocusIndex = -1;
    
    // Debounce function
    function debounce(func, wait) {
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(searchTimeout);
          func(...args);
        };
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(later, wait);
      };
    }
    
    // Keyboard navigation
    function handleKeyboardNavigation(e) {
      const cards = Array.from(document.querySelectorAll('.province-card:not(.hidden)'));
      if (cards.length === 0) return;
      
      switch(e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          currentFocusIndex = (currentFocusIndex + 1) % cards.length;
          cards[currentFocusIndex].focus();
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          currentFocusIndex = currentFocusIndex <= 0 ? cards.length - 1 : currentFocusIndex - 1;
          cards[currentFocusIndex].focus();
          break;
        case 'Enter':
        case ' ':
          e.preventDefault();
          if (currentFocusIndex >= 0 && cards[currentFocusIndex]) {
            cards[currentFocusIndex].click();
          }
          break;
        case 'Escape':
          document.getElementById('searchInput').focus();
          currentFocusIndex = -1;
          break;
      }
    }
    
    function showAllProvinces() {
      // ‡∏•‡∏ö active class ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.querySelectorAll('.province-card').forEach(c => c.classList.remove('active'));
      
      // ‡∏•‡∏ö marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });
      
      // ‡πÅ‡∏™‡∏î‡∏á marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      allTools.forEach(location => {
        if (location.latitude && location.longitude && location.devices) {
          const card = createTooltipCard(location);
          const markerColor = getMarkerColor(location.devices);
          
          const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `<svg width="25" height="41" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.5 0C5.6 0 0 5.6 0 12.5C0 19.4 12.5 41 12.5 41S25 19.4 25 12.5C25 5.6 19.4 0 12.5 0Z" fill="#333" stroke="#fff" stroke-width="2"/>
              <circle cx="12.5" cy="12.5" r="8" fill="${markerColor}"/>
            </svg>`,
            iconSize: [25, 41],
            iconAnchor: [12, 41]
          });
          
          const marker = L.marker([location.latitude, location.longitude], { icon: customIcon }).addTo(map);
          addMarkerEvents(marker, card);
        }
      });
      
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
      document.getElementById('showAllBtn').classList.add('hidden');
      
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      map.setView([13.736717, 100.523186], 6);
    }

    async function loadMapData() {
      try {
        document.getElementById('loadingScreen').classList.remove('hidden');
        document.getElementById('provinceGrid').style.display = 'none';
        
        const response = await fetch('map_data.php');
        if (!response.ok) throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + response.statusText);
        const tools = await response.json();
        allTools = tools;

        tools.forEach(location => {
          if (location.latitude && location.longitude && location.devices) {
            const card = createTooltipCard(location);
            const markerColor = getMarkerColor(location.devices);
            
            const customIcon = L.divIcon({
              className: 'custom-marker',
              html: `<svg width="25" height="41" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.5 0C5.6 0 0 5.6 0 12.5C0 19.4 12.5 41 12.5 41S25 19.4 25 12.5C25 5.6 19.4 0 12.5 0Z" fill="#333" stroke="#fff" stroke-width="2"/>
                <circle cx="12.5" cy="12.5" r="8" fill="${markerColor}"/>
              </svg>`,
              iconSize: [25, 41],
              iconAnchor: [12, 41]
            });
            
            const marker = L.marker([location.latitude, location.longitude], { icon: customIcon }).addTo(map);
            addMarkerEvents(marker, card);
          }
        });
        
        createProvinceCards(tools);
        
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('provinceGrid').style.display = 'flex';
        
      } catch (error) {
        console.error('Error loading map data:', error);
        document.getElementById('loadingScreen').classList.add('hidden');
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }

    function getProvinceFromCoordinates(lat, lng) {
      const provinces = {
        '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£': { lat: [13.5, 13.95], lng: [100.3, 100.9] },
        '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': { lat: [13.8, 14.2], lng: [100.3, 100.6] },
        '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': { lat: [13.9, 14.3], lng: [100.4, 100.8] },
        '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': { lat: [13.4, 13.8], lng: [100.4, 101.0] },
        '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': { lat: [13.2, 13.7], lng: [99.8, 100.4] },
        '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': { lat: [13.6, 14.2], lng: [99.8, 100.4] },
        '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': { lat: [18.2, 20.0], lng: [98.0, 100.0] },
        '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢': { lat: [19.0, 20.5], lng: [99.0, 100.5] },
        '‡∏•‡∏≥‡∏õ‡∏≤‡∏á': { lat: [17.8, 18.8], lng: [99.0, 100.0] },
        '‡∏•‡∏≥‡∏û‡∏π‡∏ô': { lat: [18.0, 18.8], lng: [98.8, 99.4] },
        '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô': { lat: [19.0, 20.0], lng: [97.5, 98.5] },
        '‡∏ô‡πà‡∏≤‡∏ô': { lat: [18.0, 19.5], lng: [100.0, 101.5] },
        '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': { lat: [19.0, 19.8], lng: [99.5, 100.5] },
        '‡πÅ‡∏û‡∏£‡πà': { lat: [17.8, 18.8], lng: [100.0, 101.0] },
        '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': { lat: [17.2, 17.8], lng: [100.0, 100.8] },
        '‡∏ï‡∏≤‡∏Å': { lat: [16.0, 17.5], lng: [98.0, 99.5] },
        '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢': { lat: [17.0, 17.8], lng: [99.5, 100.5] },
        '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å': { lat: [16.5, 17.2], lng: [100.0, 101.0] },
        '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£': { lat: [16.0, 16.8], lng: [99.0, 100.0] },
        '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£': { lat: [16.2, 16.8], lng: [100.0, 100.8] },
        '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå': { lat: [15.5, 16.8], lng: [100.5, 101.5] },
        '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': { lat: [15.5, 16.0], lng: [100.0, 100.8] },
        '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ': { lat: [15.0, 15.8], lng: [99.8, 100.5] },
        '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó': { lat: [15.0, 15.5], lng: [100.0, 100.5] },
        '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ': { lat: [14.5, 15.5], lng: [100.5, 101.5] },
        '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ': { lat: [14.8, 15.2], lng: [100.2, 100.8] },
        '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á': { lat: [14.4, 14.8], lng: [100.2, 100.8] },
        '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ': { lat: [14.2, 15.0], lng: [100.8, 101.5] },
        '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å': { lat: [14.0, 14.5], lng: [101.0, 101.5] },
        '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': { lat: [13.8, 14.5], lng: [101.2, 102.0] },
        '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': { lat: [13.5, 14.2], lng: [101.0, 101.8] },
        '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ': { lat: [12.5, 13.8], lng: [100.8, 102.0] },
        '‡∏£‡∏∞‡∏¢‡∏≠‡∏á': { lat: [12.4, 13.2], lng: [101.0, 101.8] },
        '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': { lat: [12.2, 13.0], lng: [101.8, 102.5] },
        '‡∏ï‡∏£‡∏≤‡∏î': { lat: [11.8, 12.8], lng: [102.2, 102.8] },
        '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß': { lat: [13.5, 14.2], lng: [102.0, 102.8] },
        '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': { lat: [13.8, 15.2], lng: [98.5, 99.8] },
        '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ': { lat: [13.2, 14.0], lng: [99.5, 100.2] },
        '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ': { lat: [12.8, 13.5], lng: [99.5, 100.2] },
        '‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå': { lat: [11.5, 12.8], lng: [99.5, 100.2] },
        '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô': { lat: [15.5, 17.0], lng: [102.0, 103.5] },
        '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ': { lat: [17.0, 18.0], lng: [102.5, 103.5] },
        '‡πÄ‡∏•‡∏¢': { lat: [17.0, 18.0], lng: [101.0, 102.5] },
        '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢': { lat: [17.5, 18.5], lng: [102.5, 104.0] },
        '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨': { lat: [18.0, 18.8], lng: [103.5, 104.5] },
        '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°': { lat: [16.5, 17.5], lng: [104.0, 105.0] },
        '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£': { lat: [16.8, 17.8], lng: [103.5, 104.5] },
        '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£': { lat: [16.2, 17.0], lng: [104.5, 105.0] },
        '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': { lat: [16.2, 17.2], lng: [103.0, 104.0] },
        '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': { lat: [15.8, 16.8], lng: [103.0, 104.5] },
        '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': { lat: [15.5, 16.5], lng: [103.0, 104.0] },
        '‡∏¢‡πÇ‡∏™‡∏ò‡∏£': { lat: [15.0, 16.0], lng: [104.0, 105.0] },
        '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç': { lat: [15.5, 16.2], lng: [104.5, 105.5] },
        '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ': { lat: [14.5, 15.8], lng: [104.5, 105.8] },
        '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©': { lat: [14.0, 15.5], lng: [103.5, 105.0] },
        '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå': { lat: [14.5, 15.2], lng: [103.0, 104.0] },
        '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå': { lat: [14.2, 15.5], lng: [102.5, 103.8] },
        '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥': { lat: [15.0, 16.5], lng: [101.5, 102.8] },
        '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤': { lat: [14.0, 15.8], lng: [101.5, 103.0] },
        '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä': { lat: [8.0, 9.0], lng: [99.5, 100.5] },
        '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà': { lat: [7.8, 8.8], lng: [98.5, 99.5] },
        '‡∏û‡∏±‡∏á‡∏á‡∏≤': { lat: [8.0, 9.0], lng: [98.0, 99.0] },
        '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï': { lat: [7.8, 8.2], lng: [98.2, 98.5] },
        '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ': { lat: [8.5, 9.8], lng: [98.8, 100.0] },
        '‡∏£‡∏∞‡∏ô‡∏≠‡∏á': { lat: [9.5, 10.5], lng: [98.5, 99.0] },
        '‡∏ä‡∏∏‡∏°‡∏û‡∏£': { lat: [10.0, 11.0], lng: [99.0, 99.8] },
        '‡∏™‡∏á‡∏Ç‡∏•‡∏≤': { lat: [6.8, 7.8], lng: [100.0, 101.0] },
        '‡∏™‡∏ï‡∏π‡∏•': { lat: [6.2, 7.0], lng: [99.5, 100.2] },
        '‡∏ï‡∏£‡∏±‡∏á': { lat: [7.0, 8.0], lng: [99.2, 100.0] },
        '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á': { lat: [7.2, 8.0], lng: [100.0, 100.8] },
        '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ': { lat: [6.5, 7.2], lng: [101.0, 101.8] },
        '‡∏¢‡∏∞‡∏•‡∏≤': { lat: [5.8, 6.8], lng: [101.0, 101.8] },
        '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™': { lat: [5.5, 6.5], lng: [101.5, 102.0] }
      };
      
      for (const [province, bounds] of Object.entries(provinces)) {
        if (lat >= bounds.lat[0] && lat <= bounds.lat[1] && 
            lng >= bounds.lng[0] && lng <= bounds.lng[1]) {
          return province;
        }
      }
      return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î';
    }

    function createProvinceCards(tools) {
      // Use cached data if available
      if (provinceCache) {
        renderProvinceCards(provinceCache);
        return;
      }
      
      const provinceData = {};
      
      tools.forEach(location => {
        if (location.latitude && location.longitude) {
          const calculatedProvince = getProvinceFromCoordinates(location.latitude, location.longitude);
          const province = location.devices?.[0]?.province || calculatedProvince;
          
          if (!provinceData[province]) {
            provinceData[province] = 0;
          }
          provinceData[province]++;
        }
      });
      
      // Cache the province data
      provinceCache = provinceData;
      renderProvinceCards(provinceData);
    }
    
    function renderProvinceCards(provinceData) {
      const provinceGrid = document.getElementById('provinceGrid');
      const searchInput = document.getElementById('searchInput');
      
      Object.entries(provinceData)
        .sort(([a], [b]) => a.localeCompare(b, 'th'))
        .forEach(([province, count]) => {
          const card = document.createElement('div');
          card.className = 'province-card';
          card.dataset.province = province;
          
          card.innerHTML = `
            <div class="province-name">${province}</div>
            <div class="province-count">${count} ‡∏à‡∏∏‡∏î</div>
          `;
          
          // Add accessibility attributes
          card.setAttribute('tabindex', '0');
          card.setAttribute('role', 'gridcell');
          card.setAttribute('aria-label', `‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î${province} ‡∏°‡∏µ ${count} ‡∏à‡∏∏‡∏î`);
          
          const clickHandler = () => {
            document.querySelectorAll('.province-card').forEach(c => {
              c.classList.remove('active');
              c.setAttribute('aria-selected', 'false');
            });
            card.classList.add('active');
            card.setAttribute('aria-selected', 'true');
            document.getElementById('showAllBtn').classList.remove('hidden');
            filterMarkersByProvince(province, allTools);
          };
          
          card.addEventListener('click', clickHandler);
          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              clickHandler();
            }
          });
          
          provinceGrid.appendChild(card);
        });
      
      // Debounced search function
      const debouncedSearch = debounce((searchTerm) => {
        const cards = document.querySelectorAll('.province-card');
        let visibleCount = 0;
        
        cards.forEach(card => {
          const provinceName = card.dataset.province.toLowerCase();
          if (provinceName.includes(searchTerm)) {
            card.classList.remove('hidden');
            visibleCount++;
          } else {
            card.classList.add('hidden');
          }
        });
        
        // Update aria-live region for screen readers
        const searchHelp = document.getElementById('search-help');
        searchHelp.textContent = `‡∏û‡∏ö ${visibleCount} ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î`;
        currentFocusIndex = -1;
      }, 300);
      
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        debouncedSearch(searchTerm);
      });
      
      // Add keyboard navigation to search input
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const firstCard = document.querySelector('.province-card:not(.hidden)');
          if (firstCard) {
            currentFocusIndex = 0;
            firstCard.focus();
          }
        }
      });
      
      // Add global keyboard navigation
      document.addEventListener('keydown', handleKeyboardNavigation);
    }

    function filterMarkersByProvince(selectedProvince, tools) {
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });
      
      const filteredTools = tools.filter(location => {
        if (location.latitude && location.longitude) {
          const calculatedProvince = getProvinceFromCoordinates(location.latitude, location.longitude);
          const province = location.devices?.[0]?.province || calculatedProvince;
          return province === selectedProvince;
        }
        return false;
      });
      
      if (filteredTools.length > 0) {
        const bounds = L.latLngBounds();
        
        filteredTools.forEach(location => {
          if (location.latitude && location.longitude) {
            bounds.extend([location.latitude, location.longitude]);
            
            const card = createTooltipCard(location);
            const markerColor = getMarkerColor(location.devices);
            const customIcon = L.divIcon({
              className: 'custom-marker',
              html: `<svg width="25" height="41" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.5 0C5.6 0 0 5.6 0 12.5C0 19.4 12.5 41 12.5 41S25 19.4 25 12.5C25 5.6 19.4 0 12.5 0Z" fill="#333" stroke="#fff" stroke-width="2"/>
                <circle cx="12.5" cy="12.5" r="8" fill="${markerColor}"/>
              </svg>`,
              iconSize: [25, 41],
              iconAnchor: [12, 41]
            });
            
            const marker = L.marker([location.latitude, location.longitude], { icon: customIcon }).addTo(map);
            addMarkerEvents(marker, card);
          }
        });
        
        if (bounds.isValid()) {
          map.fitBounds(bounds, { padding: [20, 20] });
        }
      }
    }

    loadMapData();
  </script>
</body>
</html>