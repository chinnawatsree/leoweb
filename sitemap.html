<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPS Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 90vh; width: 100%; }
    .status.Normal { color: #22c55e; font-weight: bold; }
    .status.Minor { color: #f59e42; font-weight: bold; }
    .status.Major { color: #ef4444; font-weight: bold; }
    .status.Comm\ Error { color: #6b7280; font-weight: bold; }
    .popup-btn { color: #2563eb; text-decoration: underline; margin-top: 4px; display: inline-block; }
  </style>
</head>
<body style="margin:0; padding:0;">
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([13.736717, 100.523186], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
      let openTooltip = null;
      let tooltipTimeout;
      
    // ดึงข้อมูลและปักหมุด
    async function loadMapData() {
      try {
        const response = await fetch('map_data.php');
        if (!response.ok) throw new Error('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + response.statusText);
        const tools = await response.json();

        tools.forEach(tool => {
          if (tool.latitude && tool.longitude) {
            // กล่องข้อมูลแบบ card
            const card = document.createElement('div');
            card.style.minWidth = '220px';
            card.style.background = '#fff';
            card.style.borderRadius = '14px';
            card.style.boxShadow = '0 2px 8px #e0e7ff';
            card.style.padding = '16px 14px 12px 14px';
            card.style.margin = '0';
            card.style.fontFamily = 'inherit';

            // Site name
            const site = document.createElement('div');
            site.textContent = tool.pea_code_name ?? '-';
            site.style.fontSize = '1.15rem';
            site.style.fontWeight = 'bold';
            site.style.color = '#3730a3';
            site.style.marginBottom = '8px';
            card.appendChild(site);

            // Status
            const statusRow = document.createElement('div');
            statusRow.style.display = 'flex';
            statusRow.style.alignItems = 'center';
            statusRow.style.marginBottom = '8px';

            const statusLabel = document.createElement('span');
            statusLabel.textContent = 'สถานะ: ';
            statusLabel.style.fontSize = '0.95rem';
            statusLabel.style.color = '#64748b';
            statusRow.appendChild(statusLabel);

            const statusSpan = document.createElement('span');
            statusSpan.textContent = tool.status ?? '-';
            statusSpan.className = `status ${tool.statusClass}`;
            statusSpan.style.fontSize = '1.05rem';
            statusSpan.style.padding = '2px 14px';
            statusSpan.style.borderRadius = '16px';
            statusSpan.style.marginLeft = '6px';
            statusSpan.style.fontWeight = 'bold';
            statusSpan.style.background = '#f1f5f9';
            statusRow.appendChild(statusSpan);

            card.appendChild(statusRow);

            // Last update
            const lastUpdate = document.createElement('div');
            lastUpdate.textContent = `อัปเดตล่าสุด: ${tool.last_signal_updated ?? '-'}`;
            lastUpdate.style.fontSize = '0.95rem';
            lastUpdate.style.color = '#334155';
            lastUpdate.style.marginBottom = '12px';
            card.appendChild(lastUpdate);

            // ปุ่มดูข้อมูล
            const link = document.createElement('a');
            link.href = `ups_detail.html?ups_id=${tool.ups_id}`;
            link.textContent = 'ดูข้อมูล';
            link.className = 'popup-btn';
            link.target = 'content-frame';
            link.style.display = 'block';
            link.style.width = '100%';
            link.style.textAlign = 'center';
            link.style.background = '#6366f1';
            link.style.color = '#fff';
            link.style.fontWeight = 'bold';
            link.style.fontSize = '1rem';
            link.style.padding = '8px 0';
            link.style.borderRadius = '8px';
            link.style.marginTop = '4px';
            link.style.textDecoration = 'none';
            link.style.transition = 'background 0.2s';
            link.onmouseover = () => link.style.background = '#4338ca';
            link.onmouseout = () => link.style.background = '#6366f1';
            card.appendChild(link);

            const marker = L.marker([tool.latitude, tool.longitude]).addTo(map);

              marker.on('mouseover', function (e) {
                  if (openTooltip && openTooltip !== this) {
                      openTooltip.closeTooltip();
                  }
                  this.bindTooltip(card, { permanent: true, direction: 'auto', interactive: true }).openTooltip();
                  openTooltip = this;
              });

              marker.on('mouseout', function (e) {
                  // Do nothing on mouseout to keep the tooltip open
              });
              
            marker.addTo(map);
          }
        });
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('ไม่สามารถโหลดข้อมูลแผนที่ได้');
      }
    }

    loadMapData();
  </script>
  
</body>
</html>